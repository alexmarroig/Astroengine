You are a senior full-stack backend engineer specializing in FastAPI, Swiss Ephemeris (swisseph), and production-grade APIs for mobile and web applications. You are working on an existing FastAPI project called “Premium Astrology API”, already running on Replit with Swagger documentation available at /docs and existing endpoints such as /health, /v1/chart/natal, /v1/chart/transits, and /v1/ai/cosmic-chat.
Your task is to refactor, correct, and extend this backend into a production-ready astrology platform that will serve as the exclusive backend for a premium astrology application built with Lovable (Kinvo-like UI). The frontend will only render UI and will never calculate astrology logic.
All user-facing content must be returned in Brazilian Portuguese (pt-BR) by default, regardless of internal variable names or code language. The tone must be calm, adult, technological, and trustworthy. Never use fear-based language, fatalism, deterministic predictions, or medical/therapeutic advice. Avoid mystical exaggeration. Use conditional language such as “tende a”, “pode”, “é possível”.
On home and main views, never return astrological glyphs or symbols such as ☿ ☌ □ △ ☍. Technical symbols and orbs are allowed only in explicitly marked Technical or Advanced responses for trial or premium users.
Implement API security using an API key. All endpoints except /health must require an Authorization header using the format “Bearer API_KEY”, with the key stored in Replit Secrets. If the key is missing or invalid, return HTTP 401. Configure CORS using an environment variable called ALLOWED_ORIGINS, allowing Authorization headers and standard HTTP methods. Keep Swagger documentation accessible but protected endpoints must still require the API key.
Implement user plans with the values free, trial, and premium. Each request must accept a user_id. Every new user automatically starts a 7-day full trial. After the trial expires, the user becomes free unless marked as premium. Implement basic rate limiting in memory per user_id, per endpoint, per day. Free users must have limited Cosmic Chat usage. Trial and premium users may be unlimited or have very high limits.
Implement caching in memory with TTL. Cache natal chart calculations using a hash of the full natal payload for at least 30 days. Cache daily transits and cosmic weather per user and date for at least 6 hours. Cache Mercury retrograde status per date globally for at least 12 hours. Cache life cycles per user for at least 7 days.
Correct all OpenAPI schemas so Swagger never displays “200: string” when returning structured objects. Every endpoint must declare proper Pydantic request and response models. All validation errors must return clear messages in Portuguese. Validate latitude strictly between -89.9999 and 89.9999, longitude between -180 and 180, timezone offset in minutes within a realistic range, and dates strictly in YYYY-MM-DD format. Prevent Swiss Ephemeris house calculation errors by validating inputs and safely falling back to Placidus if needed, returning a warning field instead of crashing.
Improve the existing /v1/chart/natal endpoint so it returns structured data suitable for visualization. The response must include UTC datetime, Julian day, house system, house cusps, ascendant, midheaven, and for each planet its longitude, sign in Portuguese, degree within the sign, and house number. Do not include aspects in this endpoint for free users.
Improve /v1/chart/transits so it returns a simplified app-level response. It must include a “Cosmic Weather” object containing a simplified moon phase limited to New, Waxing, Full, or Waning, the Moon sign, and one or two short sentences describing the general energetic climate of the day without symbols or jargon. It must also return simplified influence labels only, using categories equivalent to “influência fluida”, “influência desafiadora”, and “influência intensa”. If Mercury Retrograde is active on the target date, include a special system alert object with title, subtitle containing start and end dates, a calm explanatory text, a CTA string, an amber accent color, and an animation hint. Never include the Mercury glyph. Full technical aspects with names, symbols, and orbs must be included only for trial or premium users in a clearly marked technical section.
Create a new endpoint /v1/chart/render-data designed specifically to help the Lovable frontend render a circular mandala-style natal chart. This endpoint must return zodiac ring data, houses rendered as angular arcs with start and end degrees, planets normalized for circular rendering including sign, degree, house, and optionally pre-calculated normalized angles or coordinates. For premium users, include aspect render data. For home or free views, include only simplified influence labels.
Create local, non-LLM interpretation dictionaries in Brazilian Portuguese stored in a JSON file. These must include short and full interpretations for planets and houses, as well as simplified influence labels. Implement endpoints to retrieve these interpretations, where short mode is available to free users and full mode requires trial or premium access. This avoids unnecessary AI calls and ensures consistency.
Create a Life Cycles endpoint that calculates major astrological periods such as Saturn Return, Saturn Opposition, Jupiter Returns, major Uranus and Pluto periods, and eclipses touching natal points. Each cycle must include a time window, peak date, and a calm interpretation. Free users should receive a limited preview. Premium users receive the full timeline. Include a CTA URL for booking a professional reading.
Create a Solar Return endpoint that calculates and summarizes the Solar Return for a given year and location. Provide a short preview for free users and a full detailed report for premium users.
Create a Synastry endpoint that accepts two natal charts and returns a calm, non-deterministic compatibility overview. Provide a short version for free users and a deep technical version for premium users.
Refactor the existing /v1/ai/cosmic-chat endpoint so it always responds in Brazilian Portuguese by default, never uses glyphs, never gives literal predictions, and never gives medical or therapeutic advice. It must accept an astro_payload containing natal data, transits, or life cycles and use that context when available. Free users receive shorter answers and strict limits. Premium users receive deeper, chart-aware responses. The response must be plain text by default, not markdown.
Create a notifications data endpoint that returns future events suitable for app notifications, including daily briefings, system alerts such as Mercury Retrograde and eclipses, and personal triggers such as tight-orb transits and life cycle peaks for premium users. All notification texts must be short, calm, and non-alarming.
Log all requests with timestamp, user_id, endpoint, status, and latency, without logging secrets. Ensure the API remains backward compatible with existing endpoints while extending functionality.
The final result must be a clean, production-ready FastAPI backend that serves as the single source of truth for a premium astrology app, fully compatible with Lovable, with clear Swagger documentation, stable calculations, freemium logic, and a modern, trustworthy tone.
Implement these changes now